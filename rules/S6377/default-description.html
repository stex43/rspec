<div class="sect1">
<h2 id="_description">Description</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_why_is_this_an_issue">Why is this an issue?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>XML signature validations work by parsing third-party data that cannot be trusted until it is actually validated.</p>
</div>
<div class="paragraph">
<p>As with any other parsing process, unrestricted validation of third-party XML signatures can lead to security vulnerabilities. In this case, threats range from denial of service to confidentiality breaches.</p>
</div>
<div class="paragraph">
<p>By default, the Java XML Digital Signature API does not apply restrictions on XML signature validation, unless the application runs with a security manager.<br>
To protect the application from these vulnerabilities, set the <code>org.jcp.xml.dsig.secureValidation</code> attribute to <code>true</code> with the <code>javax.xml.crypto.dsig.dom.DOMValidateContext.setProperty</code> method.<br>
This attribute ensures that the code enforces the following restrictions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Forbids the use of XSLT transforms</p>
</li>
<li>
<p>Restricts the number of <code>SignedInfo</code> or <code>Manifest Reference</code> elements to 30 or less</p>
</li>
<li>
<p>Restricts the number of <code>Reference</code> transforms to 5 or less</p>
</li>
<li>
<p>Forbids the use of MD5-related signatures or MAC algorithms</p>
</li>
<li>
<p>Ensures that <code>Reference</code> IDs are unique to help prevent signature wrapping attacks</p>
</li>
<li>
<p>Forbids Reference URIs of type <code>http</code>, <code>https</code>, or <code>file</code></p>
</li>
<li>
<p>Does not allow a <code>RetrievalMethod</code> element to reference another <code>RetrievalMethod</code> element</p>
</li>
<li>
<p>Forbids RSA or DSA keys less than 1024 bits</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_noncompliant_code_example">Noncompliant code example</h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">NodeList signatureElement = doc.getElementsByTagNameNS(XMLSignature.XMLNS, "Signature");

XMLSignatureFactory fac = XMLSignatureFactory.getInstance("DOM");
DOMValidateContext valContext = new DOMValidateContext(new KeyValueKeySelector(), signatureElement.item(0)); // Noncompliant
XMLSignature signature = fac.unmarshalXMLSignature(valContext);

boolean signatureValidity = signature.validate(valContext);</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_compliant_solution">Compliant solution</h3>
<div class="paragraph">
<p>In order to benefit from this secure validation mode, set the DOMValidateContext&#8217;s <code>org.jcp.xml.dsig.secureValidation</code> property to <code>TRUE</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">NodeList signatureElement = doc.getElementsByTagNameNS(XMLSignature.XMLNS, "Signature");

XMLSignatureFactory fac = XMLSignatureFactory.getInstance("DOM");
DOMValidateContext valContext = new DOMValidateContext(new KeyValueKeySelector(), signatureElement.item(0));
valContext.setProperty("org.jcp.xml.dsig.secureValidation", Boolean.TRUE);
XMLSignature signature = fac.unmarshalXMLSignature(valContext);

boolean signatureValidity = signature.validate(valContext);</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_resources">Resources</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="https://docs.oracle.com/en/java/javase/14/security/java-xml-digital-signature-api-overview-and-tutorial.html#GUID-DB46A001-6DBD-4571-BDBC-1BBC394BF61E">Oracle Java Documentation</a> - XML Digital Signature API Overview and Tutorial</p>
</li>
<li>
<p><a href="https://owasp.org/www-project-top-ten/2017/A3_2017-Sensitive_Data_Exposure">OWASP Top 10 2017 Category A3</a> - Sensitive Data Exposure</p>
</li>
<li>
<p><a href="https://cwe.mitre.org/data/definitions/347">MITRE, CWE-347</a> - Improper Verification of Cryptographic Signature</p>
</li>
</ul>
</div>
<hr>
</div>
</div>
<div class="sect1">
<h2 id="_implementation_specification">Implementation Specification</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_message">Message</h3>
<div class="paragraph">
<p>Set the 'org.jcp.xml.dsig.secureValidation' property to true on the 'DOMValidateContext' to validate this XML signature securely.</p>
</div>
<hr>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_comments_and_links">Comments And Links</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_on_25_jan_2022_103400_quentin_jaquier_wrote">on 25 Jan 2022, 10:34:00 Quentin Jaquier wrote:</h3>
<div class="paragraph">
<p>Quick fixes (for Java): even if it is technically possible to provide a fix that would result in compliant code, it does not sound wise to set properties blindly, as it can have side effects. Fixing the issue requires a careful and good understanding of the overall context of the code.</p>
</div>
</div>
</div>
</div>